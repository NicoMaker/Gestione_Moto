<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestione Magazzino Moto</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    header {
      background: #2c3e50;
      color: white;
      padding: 20px;
      text-align: center;
    }
    
    h1 {
      margin: 0;
      font-size: 28px;
    }
    
    .tabs {
      display: flex;
      background: #34495e;
      border-bottom: 2px solid #2c3e50;
    }
    
    .tab {
      flex: 1;
      padding: 15px;
      text-align: center;
      color: white;
      cursor: pointer;
      transition: background 0.3s;
      border: none;
      font-size: 16px;
    }
    
    .tab:hover {
      background: #415869;
    }
    
    .tab.active {
      background: #3498db;
    }
    
    .content {
      padding: 20px;
    }
    
    .section {
      display: none;
    }
    
    .section.active {
      display: block;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #2c3e50;
    }
    
    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #3498db;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }
    
    .btn-primary {
      background: #3498db;
      color: white;
    }
    
    .btn-primary:hover {
      background: #2980b9;
    }
    
    .btn-success {
      background: #27ae60;
      color: white;
    }
    
    .btn-success:hover {
      background: #229954;
    }
    
    .btn-danger {
      background: #e74c3c;
      color: white;
    }
    
    .btn-danger:hover {
      background: #c0392b;
    }
    
    .btn-warning {
      background: #f39c12;
      color: white;
    }
    
    .btn-warning:hover {
      background: #d68910;
    }
    
    .btn-small {
      padding: 5px 10px;
      font-size: 12px;
      margin-left: 5px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    th {
      background: #34495e;
      color: white;
      font-weight: bold;
    }
    
    tr:hover {
      background: #f8f9fa;
    }
    
    .actions {
      display: flex;
      gap: 5px;
    }
    
    .totale {
      margin-top: 20px;
      padding: 15px;
      background: #ecf0f1;
      border-radius: 4px;
      font-size: 18px;
      font-weight: bold;
      text-align: right;
    }
    
    .valore-magazzino {
      margin-top: 10px;
      padding: 20px;
      background: #27ae60;
      color: white;
      border-radius: 4px;
      font-size: 24px;
      font-weight: bold;
      text-align: center;
    }
    
    .giacenza {
      font-weight: bold;
    }
    
    .giacenza.positiva {
      color: #27ae60;
    }
    
    .giacenza.zero {
      color: #95a5a6;
    }
    
    .tipo-carico {
      color: #27ae60;
      font-weight: bold;
    }
    
    .tipo-scarico {
      color: #e74c3c;
      font-weight: bold;
    }
    
    .form-inline {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      margin-bottom: 20px;
    }
    
    .form-inline .form-group {
      flex: 1;
      margin: 0;
    }
    
    .alert {
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    
    .alert-error {
      background: #fadbd8;
      color: #c0392b;
      border: 1px solid #e74c3c;
    }
    
    .alert-success {
      background: #d5f4e6;
      color: #229954;
      border: 1px solid #27ae60;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #95a5a6;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
    }
    
    .modal-header {
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }
    
    .modal-footer {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    #prezzo-group {
      transition: opacity 0.3s;
    }

    #prezzo-group.hidden {
      opacity: 0.3;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üèçÔ∏è Gestione Magazzino Moto</h1>
    </header>
    
    <div class="tabs">
      <button class="tab active" onclick="switchTab('prodotti')">Prodotti</button>
      <button class="tab" id="dati-tab" onclick="switchTab('dati')">Dati (Carico/Scarico)</button>
      <button class="tab" onclick="switchTab('riepilogo')">Riepilogo Magazzino</button>
    </div>
    
    <div class="content">
      <div id="prodotti-section" class="section active">
        <h2>Gestione Prodotti</h2>
        
        <div id="prodotti-alert"></div>
        
        <div class="form-inline">
          <div class="form-group" style="flex: 3;">
            <label for="nuovo-prodotto">Nome Prodotto</label>
            <input type="text" id="nuovo-prodotto" placeholder="Inserisci nome prodotto...">
          </div>
          <button class="btn btn-primary" onclick="aggiungiProdotto()">+ Aggiungi Prodotto</button>
        </div>
        
        <table id="prodotti-table">
          <thead>
            <tr>
              <th>Nome Prodotto</th>
              <th style="text-align: center;">Giacenza</th>
              <th style="text-align: center;">Azioni</th>
            </tr>
          </thead>
          <tbody id="prodotti-body">
          </tbody>
        </table>
        
        <div class="totale">
          Totale Prodotti Distinti: <span id="totale-prodotti">0</span>
        </div>
        
        <div class="totale" style="margin-top: 5px; background: #d3f0d3; color: #1e8449;">
          üì¶ Giacenza Totale Magazzino (pezzi): <span id="giacenza-totale-magazzino">0</span>
        </div>
      </div>
      
      <div id="dati-section" class="section">
        <h2>Gestione Dati (Carico/Scarico)</h2>
        
        <div id="dati-alert"></div>
        
        <div class="form-inline">
          <div class="form-group">
            <label for="dato-prodotto">Prodotto</label>
            <select id="dato-prodotto">
              <option value="">Seleziona prodotto...</option>
            </select>
          </div>
          <div class="form-group">
            <label for="dato-tipo">Tipo</label>
            <select id="dato-tipo" onchange="togglePrezzo()">
              <option value="carico">Carico</option>
              <option value="scarico">Scarico</option>
            </select>
          </div>
          <div class="form-group">
            <label for="dato-quantita">Quantit√†</label>
            <input type="number" id="dato-quantita" min="1" placeholder="Quantit√†">
          </div>
          <div class="form-group" id="prezzo-group">
            <label for="dato-prezzo">Prezzo Unitario ‚Ç¨ <span style="color: #e74c3c;">*</span></label>
            <input type="number" id="dato-prezzo" step="0.01" min="0.01" placeholder="Prezzo Unitario">
          </div>
          <button class="btn btn-success" onclick="aggiungiDato()">+ Aggiungi</button>
        </div>
        
        <table id="dati-table">
          <thead>
            <tr>
              <th>Data</th>
              <th>Prodotto</th>
              <th>Tipo</th>
              <th style="text-align: right;">Quantit√†</th>
              <th style="text-align: right;">Prezzo Unitario ‚Ç¨</th>
              <th style="text-align: right;">Prezzo Totale ‚Ç¨</th>
              <th style="text-align: center;">Azioni</th>
            </tr>
          </thead>
          <tbody id="dati-body">
          </tbody>
        </table>
        
        <div class="totale">
          Totale Movimenti: <span id="totale-dati">0</span>
        </div>

        <div class="valore-magazzino">
          üí∞ Valore Totale Magazzino: ‚Ç¨ <span id="valore-magazzino">0.00</span>
        </div>
      </div>

      <div id="riepilogo-section" class="section">
        <h2>Riepilogo Magazzino</h2>
        
        <table id="riepilogo-table">
          <thead>
            <tr>
              <th>Prodotto</th>
              <th style="text-align: center;">Giacenza Totale</th>
              <th style="text-align: right;">Valore Totale ‚Ç¨</th>
              <th style="text-align: center;">Azioni</th>
            </tr>
          </thead>
          <tbody id="riepilogo-body">
          </form-group>
          </tbody>
        </table>
        
        <div class="valore-magazzino">
          üí∞ Valore Totale Magazzino: ‚Ç¨ <span id="valore-magazzino-riepilogo">0.00</span>
        </div>
      </div>

      <div id="dettaglio-section" class="section">
        <h2>Dettaglio Lotti - <span id="dettaglio-prodotto-nome"></span></h2>
        
        <button class="btn btn-primary" onclick="tornaARiepilogo()" style="margin-bottom: 20px;">
          ‚Üê Torna al Riepilogo
        </button>
        
        <table id="dettaglio-table">
          <thead>
            <tr>
              <th>Data Carico</th>
              <th style="text-align: right;">Quantit√† Rimanente</th>
              <th style="text-align: right;">Prezzo Unitario ‚Ç¨</th>
              <th style="text-align: right;">Valore Lotto ‚Ç¨</th>
            </tr>
          </thead>
          <tbody id="dettaglio-body">
          </tbody>
        </table>
        
        <div class="totale">
          Totale Lotti: <span id="totale-lotti">0</span>
        </div>
      </div>
    </div>
  </div>
  
  <div id="modal-modifica" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Modifica Nome Prodotto</h3>
      </div>
      <div class="form-group">
        <label for="modifica-nome">Nuovo Nome</label>
        <input type="text" id="modifica-nome">
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="salvaNomeProdotto()">Salva</button>
        <button class="btn" onclick="chiudiModal()">Annulla</button>
      </div>
    </div>
  </div>
  
  <script>
    let prodotti = [];
    let dati = [];
    let prodottoInModifica = null;
    let prodottoDettaglio = null;
    
    // Funzione centrale per aggiornare tutti i dati
    function refreshAllData() {
      console.log('Aggiornamento automatico di tutte le sezioni...');
      caricaProdotti();
      caricaDati(); 
      caricaRiepilogo();
      caricaValoreMagazzino();
      caricaSelectProdotti(); // Aggiorna la dropdown nella sezione Dati
    }

    // Funzione interna pulita per cambiare tab senza dipendere dall'evento
    function forceSwitchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        
        const tabButton = document.querySelector(`.tab[onclick="switchTab('${tab}')"]`);
        
        if (tabButton) {
            tabButton.classList.add('active');
        }

        const section = document.getElementById(`${tab}-section`);
        if (section) {
            section.classList.add('active');
        }
        
        // Esegui l'aggiornamento dei dati solo se necessario
        // Lo facciamo per tutte le tab principali per coerenza con refreshAllData
        if (['prodotti', 'dati', 'riepilogo'].includes(tab)) {
          refreshAllData();
        }
    }

    function checkUrlHashAndSwitch() {
        const hash = window.location.hash.substring(1); // Rimuove il '#'
        const validTabs = ['prodotti', 'dati', 'riepilogo'];
        
        let targetTab = 'prodotti'; // Default
        
        if (hash && validTabs.includes(hash)) {
            targetTab = hash;
        }

        // Forza lo switch iniziale e l'aggiornamento dei dati
        forceSwitchTab(targetTab); 
    }

    // Inizializzazione: Chiama la funzione di refresh completa all'avvio E controlla l'URL
    document.addEventListener('DOMContentLoaded', () => {
      checkUrlHashAndSwitch(); // Inizializza la tab in base all'URL
      togglePrezzo();
    });
    
    // Switch tra tabs e aggiorna l'URL hash
    function switchTab(tab) {
      // 1. Aggiorna l'hash URL per ricordare la sezione
      if (window.location.hash !== `#${tab}`) {
          // Usiamo replaceState per evitare di riempire la cronologia con i click
          history.replaceState(null, null, `#${tab}`);
      }
      
      // 2. Esegue lo switch effettivo
      forceSwitchTab(tab); 
    }
    
    // Toggle campo prezzo
    function togglePrezzo() {
      const tipo = document.getElementById('dato-tipo').value;
      const prezzoGroup = document.getElementById('prezzo-group');
      const prezzoInput = document.getElementById('dato-prezzo');
      
      if (tipo === 'scarico') {
        prezzoGroup.classList.add('hidden');
        prezzoInput.value = '';
        prezzoInput.removeAttribute('required');
      } else {
        prezzoGroup.classList.remove('hidden');
        prezzoInput.setAttribute('required', 'required');
      }
    }
    
    // Mostra alert
    function mostraAlert(tipo, messaggio, sezione) {
      const alertDiv = document.getElementById(`${sezione}-alert`);
      alertDiv.innerHTML = `<div class="alert alert-${tipo}">${messaggio}</div>`;
      setTimeout(() => alertDiv.innerHTML = '', 3000);
    }
    
    // ===== PRODOTTI (CRUD) =====
    async function caricaProdotti() {
      try {
        const res = await fetch('/api/prodotti');
        prodotti = await res.json();
        renderProdotti();
      } catch (err) {
        console.error('Errore caricamento prodotti:', err);
      }
    }
    
    function renderProdotti() {
      const tbody = document.getElementById('prodotti-body');
      
      if (prodotti.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="empty-state">Nessun prodotto presente</td></tr>';
      } else {
        tbody.innerHTML = prodotti.map(p => `
          <tr>
            <td><strong>${p.nome}</strong></td>
            <td style="text-align: center;" class="giacenza ${p.giacenza > 0 ? 'positiva' : 'zero'}">
              ${p.giacenza}
            </td>
            <td style="text-align: center;">
              <div class="actions">
                <button class="btn btn-warning btn-small" onclick="apriModificaProdotto(${p.id}, '${p.nome.replace(/'/g, "\\'")}')">
                  ‚úèÔ∏è Modifica
                </button>
                <button class="btn btn-danger btn-small" onclick="eliminaProdotto(${p.id})">
                  üóëÔ∏è Elimina
                </button>
              </div>
            </td>
          </tr>
        `).join('');
      }
      
      document.getElementById('totale-prodotti').textContent = prodotti.length;
      
      // Calcolo e aggiornamento giacenza totale
      const giacenzaTotale = prodotti.reduce((sum, p) => sum + p.giacenza, 0);
      document.getElementById('giacenza-totale-magazzino').textContent = giacenzaTotale;
    }
    
    async function aggiungiProdotto() {
      const input = document.getElementById('nuovo-prodotto');
      const nome = input.value.trim();
      
      if (!nome) {
        mostraAlert('error', 'Inserisci il nome del prodotto', 'prodotti');
        return;
      }
      
      try {
        const res = await fetch('/api/prodotti', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nome })
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          mostraAlert('error', data.error, 'prodotti');
          return;
        }
        
        input.value = '';
        mostraAlert('success', 'Prodotto aggiunto con successo', 'prodotti');
        refreshAllData(); 
      } catch (err) {
        mostraAlert('error', 'Errore durante l\'aggiunta', 'prodotti');
      }
    }
    
    function apriModificaProdotto(id, nome) {
      prodottoInModifica = id;
      document.getElementById('modifica-nome').value = nome;
      document.getElementById('modal-modifica').classList.add('active');
    }
    
    function chiudiModal() {
      document.getElementById('modal-modifica').classList.remove('active');
      prodottoInModifica = null;
    }
    
    async function salvaNomeProdotto() {
      const nuovoNome = document.getElementById('modifica-nome').value.trim();
      
      if (!nuovoNome) {
        alert('Inserisci un nome valido');
        return;
      }
      
      try {
        const res = await fetch(`/api/prodotti/${prodottoInModifica}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nome: nuovoNome })
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          alert(data.error);
          return;
        }
        
        chiudiModal();
        mostraAlert('success', 'Nome prodotto modificato con successo', 'prodotti');
        refreshAllData(); 
      } catch (err) {
        alert('Errore durante la modifica');
      }
    }
    
    async function eliminaProdotto(id) {
      if (!confirm('Sei sicuro di voler eliminare questo prodotto?')) {
        return;
      }
      
      try {
        const res = await fetch(`/api/prodotti/${id}`, {
          method: 'DELETE'
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          mostraAlert('error', data.error, 'prodotti');
          return;
        }
        
        mostraAlert('success', 'Prodotto eliminato con successo', 'prodotti');
        refreshAllData(); 
      } catch (err) {
        mostraAlert('error', 'Errore durante l\'eliminazione', 'prodotti');
      }
    }
    
    // ===== DATI (CARICO/SCARICO) =====
    async function caricaDati() {
      try {
        const res = await fetch('/api/dati');
        dati = await res.json();
        renderDati();
      } catch (err) {
        console.error('Errore caricamento dati:', err);
        const tbody = document.getElementById('dati-body');
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state" style="color: #e74c3c;">Errore nel caricamento dei dati dal server.</td></tr>';
      }
    }
    
    function renderDati() {
      const tbody = document.getElementById('dati-body');
      
      if (dati.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Nessun movimento presente</td></tr>';
      } else {
        tbody.innerHTML = dati.map(d => {
          const dataFormatted = new Date(d.data).toLocaleString('it-IT');
          
          let prezzoUnitarioDisplay = '-';
          let prezzoTotaleDisplay = '-';
          let prezzoTotaleClass = ''; // Per colorare il prezzo totale
          
          if (d.tipo === 'carico') {
              if (d.prezzo !== null) {
                  prezzoUnitarioDisplay = `‚Ç¨ ${d.prezzo.toFixed(2)}`;
              }
              if (d.prezzo_totale !== null) {
                  // Carico: Valore positivo (Quantit√† * Prezzo Unitario)
                  prezzoTotaleDisplay = `‚Ç¨ ${d.prezzo_totale.toFixed(2)}`;
                  prezzoTotaleClass = 'tipo-carico'; // Verde
              }
          } else if (d.tipo === 'scarico') {
              if (d.prezzo_unitario_scarico !== null) {
                  // Scarico: Prezzo unitario medio di costo (Costo FIFO / Quantit√†)
                  prezzoUnitarioDisplay = `√ò ‚Ç¨ ${d.prezzo_unitario_scarico.toFixed(2)}`;
              }
              
              if (d.prezzo_totale !== null) {
                  // Scarico: Valore negativo (Costo FIFO) per mostrare la sottrazione di valore
                  const costoScarico = -Math.abs(d.prezzo_totale); 
                  prezzoTotaleDisplay = `‚Ç¨ ${costoScarico.toFixed(2)}`;
                  prezzoTotaleClass = 'tipo-scarico'; // Rosso
              }
          }

          return `
            <tr>
              <td>${dataFormatted}</td>
              <td><strong>${d.prodotto_nome}</strong></td>
              <td><span class="tipo-${d.tipo}">${d.tipo.toUpperCase()}</span></td>
              <td style="text-align: right;">${d.quantita}</td>
              <td style="text-align: right;">${prezzoUnitarioDisplay}</td>
              <td style="text-align: right;" class="${prezzoTotaleClass}"><strong>${prezzoTotaleDisplay}</strong></td>
              <td style="text-align: center;">
                <button class="btn btn-danger btn-small" onclick="eliminaDato(${d.id})">
                  üóëÔ∏è Elimina
                </button>
              </td>
            </tr>
          `;
        }).join('');
      }
      
      document.getElementById('totale-dati').textContent = dati.length;
    }
    
    async function caricaValoreMagazzino() {
      try {
        const res = await fetch('/api/valore-magazzino');
        const data = await res.json();
        document.getElementById('valore-magazzino').textContent = data.valore_totale.toFixed(2);
      } catch (err) {
        console.error('Errore caricamento valore:', err);
      }
    }
    
    function caricaSelectProdotti() {
      const select = document.getElementById('dato-prodotto');
      select.innerHTML = '<option value="">Seleziona prodotto...</option>' +
        prodotti.map(p => `<option value="${p.id}">${p.nome} (Giacenza: ${p.giacenza})</option>`).join('');
    }
    
    async function aggiungiDato() {
      const prodotto_id = document.getElementById('dato-prodotto').value;
      const tipo = document.getElementById('dato-tipo').value;
      const quantita = document.getElementById('dato-quantita').value;
      const prezzo = tipo === 'carico' ? document.getElementById('dato-prezzo').value : null;
      
      if (!prodotto_id || !quantita) {
        mostraAlert('error', 'Compila prodotto e quantit√†', 'dati');
        return;
      }

      if (tipo === 'carico' && (!prezzo || parseFloat(prezzo) <= 0)) {
        mostraAlert('error', 'Il prezzo √® obbligatorio e deve essere maggiore di 0 per il carico', 'dati');
        return;
      }
      
      try {
        const res = await fetch('/api/dati', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prodotto_id, tipo, quantita, prezzo })
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          mostraAlert('error', data.error, 'dati');
          return;
        }
        
        document.getElementById('dato-prodotto').value = '';
        document.getElementById('dato-quantita').value = '';
        document.getElementById('dato-prezzo').value = '';
        
        mostraAlert('success', 'Dato aggiunto con successo', 'dati');
        refreshAllData(); 
      } catch (err) {
        mostraAlert('error', 'Errore durante l\'aggiunta', 'dati');
      }
    }
    
    async function eliminaDato(id) {
      alert('Non √® possibile eliminare movimenti dopo la registrazione. Questo comprometterebbe il calcolo dei lotti e delle giacenze.');
      return;
    }

    // ===== RIEPILOGO =====
    async function caricaRiepilogo() {
      try {
        const res = await fetch('/api/riepilogo');
        const riepilogo = await res.json();
        renderRiepilogo(riepilogo);
      } catch (err) {
        console.error('Errore caricamento riepilogo:', err);
      }
    }

    function renderRiepilogo(riepilogo) {
      const tbody = document.getElementById('riepilogo-body');
      
      if (riepilogo.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-state">Nessun prodotto in magazzino</td></tr>';
        document.getElementById('valore-magazzino-riepilogo').textContent = '0.00';
      } else {
        let totaleGenerale = 0;
        
        tbody.innerHTML = riepilogo.map(r => {
          totaleGenerale += r.valore_totale;
          
          return `
            <tr>
              <td><strong>${r.nome}</strong></td>
              <td style="text-align: center;" class="giacenza ${r.giacenza > 0 ? 'positiva' : 'zero'}">
                ${r.giacenza}
              </td>
              <td style="text-align: right;">
                <strong>‚Ç¨ ${r.valore_totale.toFixed(2)}</strong>
              </td>
              <td style="text-align: center;">
                <button class="btn btn-primary btn-small" onclick="mostraDettaglioLotti(${r.id}, '${r.nome.replace(/'/g, "\\'")}')">
                  üì¶ Vedi Lotti
                </button>
              </td>
            </tr>
          `;
        }).join('');
        
        document.getElementById('valore-magazzino-riepilogo').textContent = totaleGenerale.toFixed(2);
      }
    }

    async function mostraDettaglioLotti(prodottoId, nomeProdotto) {
      prodottoDettaglio = prodottoId;
      document.getElementById('dettaglio-prodotto-nome').textContent = nomeProdotto;
      
      try {
        const res = await fetch(`/api/lotti/${prodottoId}`);
        const lotti = await res.json();
        renderDettaglioLotti(lotti);
        
        // Imposta la sezione dettaglio come attiva
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById('dettaglio-section').classList.add('active');

        // Aggiorna l'hash URL per riflettere la sezione dettaglio
        history.replaceState(null, null, `#dettaglio`); 

      } catch (err) {
        console.error('Errore caricamento lotti:', err);
      }
    }

    function renderDettaglioLotti(lotti) {
      const tbody = document.getElementById('dettaglio-body');
      
      if (lotti.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-state">Nessun lotto disponibile</td></tr>';
      } else {
        tbody.innerHTML = lotti.map(l => {
          const dataFormatted = new Date(l.data_carico).toLocaleString('it-IT');
          const valoreLotto = l.quantita_rimanente * l.prezzo;
          
          return `
            <tr>
              <td>${dataFormatted}</td>
              <td style="text-align: right;" class="giacenza positiva">${l.quantita_rimanente}</td>
              <td style="text-align: right;">‚Ç¨ ${l.prezzo.toFixed(2)}</td>
              <td style="text-align: right;"><strong>‚Ç¨ ${valoreLotto.toFixed(2)}</strong></td>
            </tr>
          `;
        }).join('');
      }
      
      document.getElementById('totale-lotti').textContent = lotti.length;
    }

    function tornaARiepilogo() {
      // Chiama la funzione di switch che aggiorna anche l'hash
      switchTab('riepilogo'); 
    }
  </script>
</body>
</html>